<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>签到</title>
    <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" name="viewport" />
    <meta content="yes" name="apple-mobile-web-app-capable" />
    <meta content="black" name="apple-mobile-web-app-status-bar-style" />
    <meta content="telephone=no" name="format-detection" />

    <link rel="stylesheet" href="css/ydui.css" />
    <link rel="stylesheet" href="css/style.css" />

    <script src="js/tools/jquery.min.js"></script>

    <script src="js/tools/ydui.flexible.js"></script>
    <script src="js/tools/myYDUI.js"></script>

    <script src="js/tools/baicai-validation.js"></script>

</head>

<body style="background-color:white;width:100%; height:100%;">

	<div style="position:absolute;width:100%;height:50%">
		<img src="img/titlebg.png" style="position:absolute;width:100%; height:100%; z-index:-100" />
		
		<div style="height:60%;width:100%;" class="flexHolder flexVcenter flexHcenter flexColumn">
			<p style="font-size:0.5rem;color:white">签到</p>
			<p id="hintMsg" style="color:white;padding-top:5px"></p>
		</div>
	</div>
	
	
	
	<div style="position:absolute;top:20%;left:5%;bottom:4%;width:90%;height:76%">
		<img src="img/boardbg.png" style="position:absolute; top:0; left:0; width:100%; height:100%; z-index:-100;" />
		<img id="signBtn" src="img/btn3.png" style="margin:30px 0 0 23px; width:24px;height:24px;" />
		
		
		<div style="position:relative; margin:0 0 0 20px; width:30px; height:75%; float:left ">
			<img src="img/barbg.png" style="width:100%;height:100%; position: absolute; bottom:0; z-index: -100;" />
			<div id="barfront" style="position:absolute;bottom:10px;margin-left:36%; width:28%; height:0; border-radius: 5px 5px 5px 5px; background-color:orangered;"></div>
			<div class="space"></div>
		</div>
			
		<div id="mainHolder" style="float:right; margin:0 20px 0 0; width:76%; height:75%; " class="flexHolder flexVcenter flexColumn">
		</div>
			
		
		<div class="space"></div>
		
		
		
		<div class="flexHolder flexVcenter flexHcenter">
			<img id="exBtn" src="img/btnbg2.png" style="width:100px" />
		</div>
	</div>



	
	
	
	<!-- pop win start -->
    <div id="pop_alert" style="display:none">   
        <div class="mask-black-dialog">       
            <div class="m-confirm m-alert">           
                <div class="confirm-bd"></div>           
                <div class="confirm-ft">               
                    <a href="javascript: closeWarning('pop_alert');" class="confirm-btn primary">确定</a>           
                </div>       
            </div>   
        </div>
    </div>
	
	<div class="mask-black-dialog" id="pop_confirm" style="display:none">
	    <div class="m-confirm">
	        <div class="confirm-hd">
	            <strong class="confirm-title"></strong>
	        </div>
	        <div class="confirm-bd"></div>
	        <div id="popconfirmbtn" class="confirm-ft">
	            <a href="javascript:closeWarning('pop_confirm');" class="confirm-btn default">取消</a>
	            <a href="javascript:sendExchange();"  class="confirm-btn primary">确定</a>
	        </div>
	        <div id="popconfirmsending" class="confirm-ft" style="display:none">
	        	<a class="confirm-btn primary">正在提交...</a>
	        </div>
	    </div>
	</div>
	
	<!-- pop win end -->
	
</body>

</html>


<script>



//////////////////////////////////////////////////////////////

var sendingflag = 0;

var prolist = [
	{
		proID:"1",
		proName:"立白除螨洗衣液",
		proUnlock:"200",
		proRemains:"100",
		proImg:"img/pro03.png",
		unlockDays:"20",
		isUnlock:"0",
		selected:"0"
	},
	{
		proID:"2",
		proName:"福临门食用油",
		proUnlock:"300",
		proRemains:"100",
		proImg:"img/pro02.png",
		unlockDays:"10",
		isUnlock:"1",
		selected:"0"
	},
	{
		proID:"3",
		proName:"尚岛宜家垃圾袋",
		proUnlock:"400",
		proRemains:"12",
		proImg:"img/pro01.png",
		unlockDays:"5",
		isUnlock:"1",
		selected:"0"
	}
];

var userinfo = {
	status:"incombo", //break  exchanged start signed
	hintMsg:"已连续签到7天",
	comboDays:"20",
	breakDate:""
}



// getPageData();

updateUserDisp();
createListView("#mainHolder");


// getList();

//////////////////////////////////////////////////////////////

$("#signBtn").click(function(e){
	sendSign();
});


$("#exBtn").click(function(e){
	exchangePro();
});

//////////////////////////////////////////////////////////////



function getPageData(){
	var url = "../pagedata.do";
	var data = {};
	$.post(url,data,null,"json").success(function(re){
		if(re.result=="success"){
			var json = new Function("return"+re.msg)();
			prolist = new Function("return"+json.prolist)();
			userinfo = new Function("return"+json.userinfo)();
			updateUserDisp();
			createListView("#mainHolder");
		}
		else{
			openWarning("pop_alert","提示",re.msg);
		}
	}).error(function(e){
		openWarning("pop_alert","提示","网络错误,请重试");
	});
}


function sendSign(){
	var url = "../signname.do";
	var data = {};
	
	if(sendingflag==0){
		sendingflag = 1;
		$.post(url,data,null,"json").success(function(re){
			sendingflag==0;
			if(re.result=="success"){
				userinfo.comboDays = Number(userinfo.comboDays)+1;
				userinfo.hintMsg = "今日已签到";
				userinfo.status = "incombo";
				updateUserDisp(); 
				updateUnlock();
				openWarning("pop_alert","提示","签到成功");
			}
			else{
				openWarning("pop_alert","提示",re.msg);
			}
		}).error(function(e){
			sendingflag==0;
			openWarning("pop_alert","提示","网络错误,请重试");
		});
	}
}


function exchangePro(){
	var url = "../exchange.do";
	var data = {
		proID:getSelected()
	};
	if(data.proID=="-1"){
		openWarning("pop_alert","提示","请选择一个商品");
	}
	else{
		openWarning("pop_confirm","提示","确认兑换?");
	}
}
function sendExchange(){
	$("#popconfirmbtn").hide();
	$("#popconfirmsending").show();
	
	var url = "../exchange.do";
	var data = {
		proID:getSelected()
	};
	$.post(url,data,null,"json").success(function(re){
		if(re.result=="success"){
			openWarning("pop_alert","提示",re.msg);
		}
		else{
			openWarning("pop_alert","提示",re.msg);
		}
		closeWarning("pop_confirm");
		$("#popconfirmsending").hide();
		$("#popconfirmbtn").show();
	}).error(function(e){
		closeWarning("pop_confirm");
		$("#popconfirmsending").hide();
		$("#popconfirmbtn").show();
		openWarning("pop_alert","提示","网络错误,请重试");
	});
}



function updateUserDisp(){
	var condition = getUnlockCondition();
	if(userinfo.status=="incombo"){
		$("#hintMsg").html(userinfo.hintMsg);
		setProgressBar(userinfo.comboDays);
	}
	else if(userinfo.status=="break"){
		$("#hintMsg").html(userinfo.hintMsg);
		setProgressBar("0");
	}
	else{
		//exchanged
		$("#hintMsg").html(userinfo.hintMsg);
		setProgressBar(userinfo.comboDays);
	}
}



function createListView(selector){
	var htmlstr = "";
	for(var i=0; i<prolist.length; i++){
		var item = prolist[i];
		htmlstr += 
			"<div style=\"width:100%; height:50px; flex-grow: 1;\" class=\"flexHolder flexVcenter \">"+
				"<div class=\"flexHolder flexVcenter flexHcenter listblock\" style=\"position: relative;\">"+
					"<div id=\"selectbox_"+item.proID+"\" class=\"selectbox "+(item.selected=="0"?"hideDisp":"")+"\">"+
						"<div class=\"selectlabel\"></div>"+
					"</div>"+
					
					"<div class=\"flexHolder flexColumn flexVcenter iconblock\">"+
						"<img id=\"lockimg_"+item.proID+"\" src=\""+(item.isUnlock=="1"?"img/unlock.png":"img/lock.png")+"\" class=\"lockicon\" />"+
						"<p class=\"corangered marginT5 fweight600\">"+item.unlockDays+"天</p>"+
					"</div>"+
					"<div class=\"flexHolder flexVcenter flexHcenter proimage\">"+
						"<img src=\""+item.proImg+"\" class=\"proimagesize\"/>"+
					"</div>"+
					"<div class=\"flexHolder flexColumn flexVcenter protext\">"+
						"<input id=\"proid_"+item.proID+"\" type=\"hidden\" value=\""+item.proID+"\" />"+
						"<p class=\"proname\">"+item.proName+"</p>"+
						"<p class=\"csuborange marginT5\">已解锁人数:"+item.proUnlock+"</p>"+
						"<p class=\"csuborange\">商品剩余:"+item.proRemains+"</p>"+
					"</div>"+
				"</div>"+
			"</div>";
	}
	htmlstr += "<div class=\"space\"></div>";
	$(selector).html(htmlstr);
	
	addSelectorClick(".listblock");
}




function setProgressBar(combo){
	var l = 94;
	var step = Math.floor(l/20.0*100)/100;
	var value = step*combo;
	$("#barfront").css("height",value+"%");
}


///////////////////////////////////////////////////////////

function updateUnlock(){
	var combo = Number(userinfo.comboDays);
	for(var i=0; i<prolist.length; i++){
		var item = prolist[i];
		if(combo >= Number(item.unlockDays)){
			item.isUnlock="1";
			//document.getElementById("lockimg_"+item.proID).src="img/unlock.png";
			$("#lockimg_"+item.proID).attr("src","img/unlock.png");
		}
	}
}


function addSelectorClick(selector){
	$(selector).each(function(i,e){
		$(this).click(function(e){
			checkSelect(i);
		});
	});
}


function checkSelect(index){
	for(var i=0; i<prolist.length; i++){
		var item = prolist[i];
		item.selected = "0";
		if(!$("#selectbox_"+item.proID).hasClass("hideDisp")){
			$("#selectbox_"+item.proID).addClass("hideDisp");
		}
		
		if(i==index){
			if(item.isUnlock=="1"){
				if($("#selectbox_"+item.proID).hasClass("hideDisp")){
					$("#selectbox_"+item.proID).removeClass("hideDisp");
				}
				item.selected = "1";
			}
			else{
				openWarning("pop_alert","提示","请继续签到解锁商品");
			}
		}
	}
}


function getSelected(){
	for(var i=0; i<prolist.length; i++){
		var item = prolist[i];
		if(!$("#selectbox_"+item.proID).hasClass("hideDisp")){
			return $("#proid_"+item.proID).val();
		}
	}
	return "-1";
}


function getUnlockCondition(){
	var res = [];
	for(var i=0; i<prolist.length; i++){
		res.push(prolist[i].unlockDays);
	}
	return res;
}



</script>